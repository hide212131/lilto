## Context

既存実装には固定間隔 heartbeat と登録ジョブ実行基盤があるが、ジョブ内容はコード側で固定され、会話履歴を使った自律的な改善ループは実装されていない。今回の変更では、組み込みスキル `liltobook` に heartbeat 用の行動方針を文書化し、Main の heartbeat 処理から `pi-coding-agent` にその文書を読ませて実行する。あわせて、スキル生成はユーザー承認を必須化し、重複スキル作成を抑止する。

## Goals / Non-Goals

**Goals:**
- 組み込みスキルとして `liltobook/SKILL.md` と `liltobook/HEARTBEAT.md` を追加する。
- heartbeat tick で `HEARTBEAT.md` を入力として `pi-coding-agent` 実行を起動できるようにする。
- 目的達成後に再利用可能な手順を検出した場合、`skill-creator` によるスキル化提案を行う。
- スキル作成前にユーザー確認を要求し、承認時のみ保存する。
- 既存スキルとの重複・類似を検出し、多重作成を回避する。

**Non-Goals:**
- heartbeat の間隔制御アルゴリズム自体の変更。
- `skill-creator` スキル本体の生成ロジック刷新。
- 会話履歴の長期保存方式や検索基盤の全面刷新。

## Decisions

1. heartbeat 実行入力はコード埋め込みではなく `HEARTBEAT.md` を一次ソースにする。
- 理由: 変更方針を文書で管理でき、将来の運用改善をコード修正なしで反映しやすい。
- 代替案: heartbeat ロジックへ固定プロンプトを直書きする。
- 不採用理由: 実験や改善時にリリース頻度が上がり、保守コストが高い。

2. `liltobook` は組み込みスキルとして配布し、SKILL.md で HEARTBEAT.md の存在を明示する。
- 理由: スキル探索対象に自然に載り、実行基盤から同一規約で参照できる。
- 代替案: heartbeat 専用の別設定ファイルを導入する。
- 不採用理由: 既存スキル資産管理と分断され、運用が二重化する。

3. 自律スキル化フローには「承認ゲート」と「重複抑止」を必須で入れる。
- 理由: 生成スパムや意図しない保存を防ぎ、ユーザー制御を維持する。
- 代替案: 自動作成して後から取り消し可能にする。
- 不採用理由: 取り消し前に無用なスキルが増え、品質低下と混乱を招く。

4. 重複判定はスキル名一致だけでなく、説明・手順要約の類似も使って抑止する。
- 理由: 名前違いの同種スキル乱立を防止するため。
- 代替案: スキル名の完全一致のみを重複条件にする。
- 不採用理由: 同義名で重複作成される穴が残る。

## Risks / Trade-offs

- [Risk] HEARTBEAT の指示が曖昧だと、毎 tick で不要な提案が増える。 → Mitigation: 「目的達成後のみ」「再利用価値がある場合のみ」などの実行条件を HEARTBEAT.md に明記し、提案頻度を制御する。
- [Risk] 類似判定が厳しすぎると有用な新規スキルが作れない。 → Mitigation: 閾値と比較対象（名前/説明/手順）を段階的に評価し、抑止理由をユーザーに表示する。
- [Risk] 承認待ち UI が未整備だと heartbeat 処理が停滞する。 → Mitigation: 承認要求は既存の会話 UI 経由で明示し、未回答時は次 tick で再実行せず保留状態を保持する。
- [Trade-off] 文書駆動にすることで柔軟性は上がるが、文書品質に実行品質が依存する。 → Mitigation: 組み込み文書に最小限の運用ガイドを含め、変更時にレビュー対象へ入れる。
