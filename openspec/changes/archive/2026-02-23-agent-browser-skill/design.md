## Context

チャット経由のブラウザ操作依頼に対し、現状は明確な自動実行の経路がない。Agent Skills 標準（SKILL.md + frontmatter）に準拠したスキルを読み込み、代表例として `agent-browser` を同梱することで、ブラウザ操作を再現可能な形で実行できるようにする。既存実装は最小限のスキル登録を前提としているため、スキルディレクトリの発見・メタデータ読み込み・オンデマンド実行の流れを拡張する必要がある。

## Goals / Non-Goals

**Goals:**
- プロジェクト内の組み込みスキルを自動発見し、SKILL.md からメタデータを読み込める
- `agent-browser` を組み込みスキルとして登録し、ブラウザ操作依頼時に選択可能にする
- スキル一覧提示とオンデマンド読み込みの挙動を明確化する

**Non-Goals:**
- 任意の外部リポジトリからの動的取得・自動インストール
- ブラウザ操作の詳細ワークフローや UI の定義
- WASM 等の動的ロード方式

## Decisions

- **スキル配置の標準パスを新設する**
  - 例: `skills/` 配下にスキルディレクトリを置く
  - 理由: 発見ルールを固定し、初期設定なしで同梱スキルを見つけられるようにする
  - 代替案: 設定ファイルで任意パスを指定。初期体験が複雑になるため不採用

- **SKILL.md の frontmatter をメタデータ源にする**
  - 理由: pi-mono の skills.md 仕様に合わせ、同一フォーマットで一覧化できる
  - 代替案: 独自 JSON マニフェスト。互換性が低下するため不採用

- **スキルは「一覧取得時に軽量読み込み」「実行時に本体読み込み」の二段階にする**
  - 理由: 起動時のコストを抑えつつ、必要時に確実に読み込むため
  - 代替案: 起動時に全スキルをロード。起動時間とメモリが増えるため不採用

- **`agent-browser` をリポジトリに同梱する**
  - 理由: 外部取得に依存せず、オフライン/CI 環境でも再現可能にするため
  - 代替案: Git submodule 等の動的依存。参照先管理コストが増えるため不採用

- **作業フォルダは `~/.pi/workspaces/<project>` に固定する**
  - 理由: SKILL.md の配置場所（読み取り専用）と作業フォルダ（使い捨て）を分離し、再現性と安全性を高めるため
  - 代替案: 実行時 `cwd` に依存。実行環境差分で不安定になるため不採用

- **配布時のスキル配置はアプリ専用ディレクトリ + `~/.pi/settings.json` で追加する**
  - 例: `<app data>/skills/agent-browser/SKILL.md` に展開し、`~/.pi/settings.json` の `skills` に `<app data>/skills` を追加
  - 理由: グローバル領域を汚さず、アンインストール時に安全に削除できるため
  - 代替案: `~/.pi/agent/skills/` 直下に展開。他アプリと混在し管理が難しくなるため不採用

## Risks / Trade-offs

- [スキルの互換性維持] → 参照仕様（skills.md）に追従するチェックリストを導入する
- [起動時のスキャンコスト増加] → スキルディレクトリの限定とキャッシュ化で抑制する
- [ブラウザ自動化の安全性] → 実行スキルのホワイトリスト化とログ出力を必須にする
- [作業フォルダの固定化による容量増加] → 定期クリーンアップと TTL 方針を設ける

## Migration Plan

1. `skills/` 配下に組み込みスキル構造を追加
2. スキル発見ロジックを `skills/` を対象に拡張
3. SKILL.md 解析とメタデータ一覧化を追加
4. `agent-browser` を登録し、ブラウザ操作依頼時の選択ロジックに統合
5. 既存スキルがある場合は新しい発見ルールに合わせて整理

## Open Questions

- `skills/` 以外のパス指定を将来的に許容するか
- `agent-browser` の実行権限・サンドボックス境界をどう定義するか
- スキル一覧の提示形式（チャット返答/GUI/CLI）の優先順位
