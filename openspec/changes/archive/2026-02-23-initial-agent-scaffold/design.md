## Context

Lilt-o は、PC 操作を代理実行する軽量エージェントを目標とし、Electron をアプリ基盤、Pi の `pi-coding-agent` をエージェント実行基盤として採用する方針である。現時点では要件が README レベルで、Main/Renderer の責務境界、IPC 契約、定期実行モデルが未定義なため、実装の着手点と検証観点が曖昧である。

最初の実装では、機能を広げる前に「常駐できること」「テキスト要求を受けてエージェント応答を返せること」「定期実行が動くこと」を最小単位で成立させる。

## Goals / Non-Goals

**Goals:**
- Electron の Main/Renderer 分離を前提とした最小アーキテクチャを定義する。
- Renderer からのテキスト要求を Main 経由で `pi-coding-agent` SDK に渡し、結果を UI に返す往復経路を成立させる。
- ハートビートで定期ジョブを実行し、将来の自動処理拡張に備える。
- 音声機能を除外した初期実装スコープを明確化し、開発順序を固定する。

**Non-Goals:**
- ウェイクワード検出や音声認識の実装。
- 高度な権限管理、複雑なジョブスケジューラ、永続化戦略の最適化。
- macOS/Windows 向けの配布・署名・インストーラ整備。

## Decisions

1. Main プロセスにエージェント実行責務を集中させる
- 採用: `pi-coding-agent` の SDK 初期化・実行・ツールアクセスは Main のみで扱う。
- 理由: Renderer に Node 依存やファイル I/O を直接持ち込まず、セキュリティ境界を明確にできる。
- 代替案: Renderer で直接エージェントを動かす案は、依存ライブラリ制約と攻撃面拡大のため不採用。

2. エージェント呼び出しは SDK を標準経路とし、CLI の別プロセス実行を採用しない
- 採用: Main から `pi-coding-agent` SDK を直接呼び出す。
- 理由: プロセス間連携コストが低く、型付きAPIによる入出力管理とエラーハンドリングの一貫性を保てる。
- 代替案: CLI を `spawn` などで別プロセス実行する案は、監視・リトライ・構造化エラー処理が複雑化するため不採用。

3. Renderer とは限定 IPC 契約で接続する
- 採用: `submitPrompt` と `promptResult` を中心に、最小の request/response 形式を定義する。
- 理由: 後方互換性を保ちつつ契約テストを追加しやすく、将来のストリーミング拡張にも移行しやすい。
- 代替案: 双方向の汎用イベントバスは柔軟だが、初期段階で契約不透明性が高くなるため不採用。

4. ハートビートは固定間隔ポーリングで開始する
- 採用: Main にシンプルな tick ループを置き、登録ジョブを順次実行する。
- 理由: 実装が小さく、デバッグや観測が容易で、最初の運用フィードバックを得やすい。
- 代替案: cron 互換スケジューラ導入は依存と設定コストが高いため後続フェーズへ延期。

5. Capability ごとに仕様を分離する
- 採用: `desktop-shell` / `agent-bridge` / `heartbeat-jobs` を独立 spec として管理する。
- 理由: 変更影響の局所化と段階実装がしやすく、将来の音声機能追加時にも差分管理しやすい。
- 代替案: 1 つの巨大 spec に統合する案は可読性と保守性の低下リスクがあるため不採用。

## Risks / Trade-offs

- [Risk] Main プロセスに責務が集中し、将来的にボトルネック化する可能性 → Mitigation: IPC 契約を明確にし、実行キュー/ワーカー分離へ段階移行できる構造にする。
- [Risk] 固定間隔ハートビートで不要実行が発生する可能性 → Mitigation: ジョブごとに有効/無効フラグと最終実行時刻を持たせ、将来 cron 化可能なインターフェースを維持する。
- [Risk] Renderer と Main の契約不整合で UI が停止する可能性 → Mitigation: 入出力スキーマ検証と失敗時フォールバック応答を標準化する。

## Migration Plan

1. Electron の最小起動構成を整備し、Main/Renderer の責務境界をコード構造として固定する。
2. Main に `pi-coding-agent` SDK の初期化レイヤーを実装し、Renderer から 1 往復のテキスト実行を通す。
3. ハートビート実行基盤を追加し、ダミージョブで定期実行パスを検証する。
4. ログとエラー通知を整備し、次フェーズ（音声入力、ジョブ高度化）へ進む準備を行う。

ロールバック方針: 問題発生時はハートビート機能を無効化し、手動テキスト要求のみを有効化した最小構成に戻す。

## Open Questions

- `pi-coding-agent` を Electron Main に組み込む際の初期化パラメータ（認証情報・モデル設定）をどこまで環境変数化するか。
- Windows と macOS での常駐挙動差（起動時自動起動、トレイ挙動）を初期仕様に含めるか。
- ジョブ登録情報を初期段階でメモリ保持に限定するか、簡易永続化を先に導入するか。
