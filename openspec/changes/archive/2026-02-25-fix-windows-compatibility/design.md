## Context

現状の実装と運用手順は WSL2 での成功パスに寄っており、Windows ネイティブの PowerShell 環境では実行ポリシーにより `*.ps1` 経由コマンドが失敗しやすい。加えて、コマンド呼び出し・パス区切り・プロセス起動時の挙動差により、同一手順でも OS ごとに結果が変わる。

本変更では、Windows を第一級サポート対象として「起動できる」だけでなく「主要フローが同じ期待結果になる」ことを設計上の基準にする。

## Goals / Non-Goals

**Goals:**
- Windows で `openspec` とアプリ実行に必要なコマンドが再現可能に動く実行ルールを確立する。
- Main プロセスのコマンド実行レイヤーで OS 差異を吸収し、Windows では `.cmd` を優先して失敗率を下げる。
- 既存の WSL2/Linux 動作を壊さず、同じ手順で同等の結果が得られる検証条件を用意する。

**Non-Goals:**
- UI デザインや機能仕様の追加変更。
- プロバイダー機能やモデル機能の新規追加。
- OS 非依存性を超える高度な抽象化（専用ランタイム層の大規模再設計）。

## Decisions

1. 実行コマンドは OS 判定で分岐し、Windows では `npm.cmd` / `npx.cmd` / `openspec.cmd` を標準とする。  
   - 理由: PowerShell 実行ポリシーで `.ps1` がブロックされる環境を既定で吸収できる。  
   - 代替案: 実行ポリシー変更を前提化。却下理由は、開発者端末依存が強く再現性が落ちるため。

2. パス・コマンド引数は Main 側で正規化し、Windows では絶対パス/区切り文字差による失敗を減らす。  
   - 理由: 呼び出し元ごとに分岐を散らすより、共通実行点で吸収したほうが保守しやすい。  
   - 代替案: 呼び出し元ごとの個別対応。却下理由は漏れや回帰を招きやすいため。

3. OpenSpec 運用フローは Windows 互換の実行形式を手順として明示する。  
   - 理由: 実装が正しくても運用手順が OS 非対応だと実利用で止まるため。  
   - 代替案: 実装のみ修正。却下理由はドキュメントと実運用の乖離が残るため。

4. 互換性の受け入れ基準は「new/status/instructions が Windows で通ること」と「既存フロー（WSL2）を壊さないこと」の両立とする。  
   - 理由: 片系統のみ成功では回帰リスクが高い。

## Risks / Trade-offs

- [Risk] Windows 固有分岐の追加でコードパスが増え、保守負荷が上がる → Mitigation: 実行分岐を共通ユーティリティに集約し、テストで OS 別期待値を固定化する。
- [Risk] `.cmd` 固定に寄せすぎると非 Windows での挙動を誤る可能性 → Mitigation: `process.platform` 判定を単一箇所に限定し、既存パスは維持する。
- [Risk] 運用ドキュメント更新漏れで手順が再び不一致になる → Mitigation: OpenSpec tasks にドキュメント更新を明示タスク化する。

## Migration Plan

1. 実行コマンドの共通化ポイントを特定し、Windows 用シム選択ロジックを追加する。  
2. OpenSpec 実行関連手順・検証手順を Windows 対応に更新する。  
3. Windows 上で `new change` → `status` → `instructions` を実行し、apply 前フローが再現できることを確認する。  
4. WSL2/Linux の既存フローで回帰がないことを確認する。  
5. 問題時のロールバックは、実行分岐追加コミットを戻し既存コマンド解決へ復帰する。

## Open Questions

- Windows での E2E 完了条件を GUI 変更時の既存ゲートとどう統合するか。
- CI 上で Windows ジョブを常時有効化するか、手動検証ゲートを維持するか。