## Context

README に定義された「Electron Main プロセスで `pi-coding-agent` SDK を活用する」要件を実装するには、既存の `agent-bridge` を土台に、LLM 実行経路と認証導線を Pi SDK に統一する必要がある。特に Claude 利用時は OAuth トークン取得が必須であり、認証未完了時の UI 状態と Main/Renderer 間 IPC 契約を先に固定しないと、実装時の手戻りが大きくなる。

今回の変更は Main（エージェント実行・認証管理）、Renderer（認証導線とチャット UI）、外部（Claude OAuth）の 3 境界をまたぐため、仕様より先に技術判断を明確化する。

## Goals / Non-Goals

**Goals:**
- Main プロセス内で `pi-coding-agent` SDK を起点に問い合わせ実行する経路を標準化する。
- Pi の `ai` パッケージを使って Claude OAuth トークンを取得し、認証完了後にチャットを即時利用可能にする。
- 認証開始から完了までを UI でシームレスに案内し、失敗時もユーザーが次アクションを判断できる状態を提供する。
- 認証状態・実行状態を IPC で一貫管理し、Renderer が安全に状態反映できる契約を定義する。

**Non-Goals:**
- Claude 以外の LLM プロバイダ対応。
- 複数アカウント切替やチーム管理の導入。
- OAuth トークンの長期暗号化保管戦略の最適化（初期は既存の設定ストア方針に従う）。

## Decisions

1. Main で SDK を内包する `AgentRuntime` 層を新設し、Renderer は直接 SDK を触らない
- 採用: `AgentRuntime` が `pi-coding-agent` のセッション生成、問い合わせ実行、失敗正規化を担う。
- 理由: SDK 依存を Main に閉じ込め、UI 変更と実行ロジック変更を分離できる。
- 代替案: Renderer 側で SDK 呼び出しを行う案は、認証情報露出と責務混在を招くため不採用。

2. Claude 認証は Pi `ai` パッケージの OAuth API を唯一の経路とする
- 採用: 認証開始、コールバック処理、トークン再利用を `ai` パッケージ API 経由で実装する。
- 理由: 独自 OAuth 実装を避け、将来の Pi 側 API 更新に追従しやすくする。
- 代替案: 直接 HTTP で OAuth を実装する案は保守コストとセキュリティリスクが高く不採用。

3. 認証導線は状態機械（未認証 / 認証中 / 認証済み / 失敗）で UI を制御する
- 採用: Main が認証状態を保持し、Renderer は状態イベントで表示を切り替える。
- 理由: 画面リロードや遅延応答時でも UI の整合性を保ちやすい。
- 代替案: ボタン押下ごとの場当たり制御は競合状態が増えるため不採用。

4. 未認証時のチャット実行は拒否し、認証開始アクションに誘導する
- 採用: `submitPrompt` 受信時に認証状態を検証し、未認証なら専用エラーコードを返す。
- 理由: 無効な API 呼び出しを減らし、ユーザーが必要手順を即座に理解できる。
- 代替案: 暗黙で認証を開始する案は、意図しないブラウザ遷移や失敗時の原因不明化を招くため不採用。

5. OAuth コールバックは外部ブラウザ誘導を標準とし、アプリ復帰を促す
- 採用: 認証は外部ブラウザで実施し、完了後にアプリへ戻る導線（Deep Link またはコールバック受信）を提供する。
- 理由: 既存ログイン状態を活用でき、埋め込みブラウザ制限への互換性が高く、認証成功率を上げられる。
- 代替案: Electron 内ブラウザ完結案は provider 制約や Cookie 差分による失敗リスクが高いため標準経路にしない。

## Risks / Trade-offs

- [Risk] OAuth コールバック受信失敗で認証中状態に固着する可能性 → Mitigation: 認証タイムアウトを設定し、一定時間で失敗状態へ遷移して再試行を可能にする。
- [Risk] Pi SDK バージョン差異で API 破壊が起きる可能性 → Mitigation: SDK アダプタを薄く設け、呼び出し点を 1 箇所に集約する。
- [Risk] 認証状態と UI 表示の不整合が発生する可能性 → Mitigation: Main を状態の単一情報源とし、Renderer は受信イベントのみで描画更新する。

## Migration Plan

1. Main に `AgentRuntime` と `ClaudeAuthService` を追加し、既存のエージェント呼び出しを段階的に移管する。
2. `submitPrompt` 処理前に認証状態チェックを追加し、未認証時エラーコードを返す。
3. Renderer に認証導線 UI（開始、進行表示、完了表示、再試行）を追加し、IPC 契約へ接続する。
4. 手動テストで「未認証→OAuth→認証済み→質問→応答」の通し動作を確認する。

ロールバック方針: 認証フローに問題が出た場合は認証導線 UI を feature flag で無効化し、既存のチャット機能のみ維持する。

## Open Questions

- Pi `ai` パッケージの OAuth トークン有効期限と更新契約を、どの時点で自動再認証に反映するか。
- 認証失敗理由をどこまでユーザー向け文言に変換するか（内部エラー詳細の露出範囲）。
